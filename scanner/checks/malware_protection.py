from __future__ import annotations
import platform
from scanner.models import ControlResult

def run(osw, mac, lin) -> ControlResult:
    system = platform.system()
    findings, recs, details = [], [], {}
    status = "unknown"; score = 0.7

    if system == "Windows":
        av = osw.av_status(); details["windows_av"] = av
        prods = av.get("products", [])
        if prods:
            status, score = "pass", 1.0
        else:
            status = "fail"; score = 0.0
            findings.append("No AV product detected via SecurityCenter2")
            recs.append("Install and enable a reputable antivirus with real-time protection")
        
        # Check BitLocker encryption (MANDATORY for CE 2025)
        encryption = osw.bitlocker_status(); details["encryption"] = encryption
        if encryption.get("enabled") is False:
            findings.append("BitLocker encryption not enabled on all volumes (REQUIRED for CE 2025)")
            recs.append("Enable BitLocker on all drives (MANDATORY for mobile/portable devices)")
            status = "fail"; score = 0.0
        elif encryption.get("enabled") is None:
            findings.append("Cannot determine BitLocker status - may require admin privileges")
            recs.append("Run as Administrator to check encryption status")
        
        # Check application control (whitelisting/sandboxing)
        app_control = osw.application_control_status(); details["application_control"] = app_control
        if not app_control.get("applocker") and not app_control.get("wdac"):
            findings.append("No application whitelisting detected (AppLocker/WDAC)")
            recs.append("Consider enabling AppLocker or Windows Defender Application Control")
        
    elif system == "Darwin":
        gk = mac.gatekeeper_status(); details["gatekeeper"] = gk
        if gk.get("enabled") is True:
            status, score = "pass", 1.0
        else:
            status = "warn"
            findings.append("Gatekeeper is disabled or unknown")
            recs.append("Enable Gatekeeper to block untrusted apps")
        
        # Check FileVault encryption (MANDATORY for CE 2025)
        encryption = mac.filevault_status(); details["encryption"] = encryption
        if encryption.get("enabled") is False:
            findings.append("FileVault encryption not enabled (REQUIRED for CE 2025)")
            recs.append("Enable FileVault disk encryption (MANDATORY for mobile devices)")
            status = "fail"; score = 0.0
        elif encryption.get("enabled") is None:
            findings.append("Cannot determine FileVault status")
            recs.append("Check FileVault status in System Preferences > Security")
        
        # Check application control
        app_control = mac.application_control_status(); details["application_control"] = app_control
        if app_control.get("gatekeeper") != "enabled":
            findings.append("Gatekeeper not fully enabled")
            recs.append("Enable Gatekeeper to enforce app security")
        
    else:
        clam = lin.clamav_status(); details["clamav"] = clam
        if clam.get("installed") and clam.get("active"):
            status, score = "pass", 1.0
        elif clam.get("installed") and not clam.get("active"):
            status = "warn"
            findings.append("ClamAV installed but not active")
            recs.append("Enable clamd/clamav-daemon and schedule regular scans")
        else:
            status = "warn"
            findings.append("No malware protection detected")
            recs.append("Install and enable ClamAV or an enterprise malware protection agent")
        
        # Check disk encryption (MANDATORY for CE 2025)
        encryption = lin.disk_encryption_status(); details["encryption"] = encryption
        if not encryption.get("encrypted"):
            findings.append("Disk encryption not detected (REQUIRED for CE 2025)")
            recs.append("Enable LUKS encryption (MANDATORY for mobile/portable devices)")
            status = "fail"; score = 0.0
        
        # Check AppArmor/SELinux
        app_control = lin.application_control_status(); details["application_control"] = app_control
        if not app_control.get("apparmor") and not app_control.get("selinux"):
            findings.append("No mandatory access control detected (AppArmor/SELinux)")
            recs.append("Enable and configure AppArmor or SELinux")

    return ControlResult(
        name="malware_protection",
        status=status,
        score=score,
        findings=findings,
        recommendations=recs,
        details=details
    )